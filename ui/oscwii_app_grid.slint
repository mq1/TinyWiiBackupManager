// SPDX-FileCopyrightText: 2025 Manuel Quarneti <mq1@ik.me>
// SPDX-License-Identifier: GPL-3.0-only

import { ScrollView, Vertical, Horizontal, MaterialText, Dialog, TextField, SegmentedButton } from "@material";
import { OscWiiAppCard, OscWiiAppCardButtons } from "oscwii_app_card.slint";
import { OscWiiApp } from "common.slint";

export component OscWiiAppGrid inherits ScrollView {
    in property <[OscWiiApp]> apps;
    out property <string> filter: "";
    property <bool> as_list: false;

    property <length> card_w: as_list ? self.width - 16px : 176px;
    property <length> card_h: as_list ? 42px : 230px;

    property <int> columns: as_list ? 1 : (self.width / card_w).floor();
    property <int> rows: as_list ? apps.length : (apps.length / columns).ceil();

    callback open_url(string);
    callback download_oscwii(string);
    callback push_oscwii(OscWiiApp);
    callback update_filter(string);

    horizontal-stretch: 1;
    vertical-stretch: 1;
    viewport_height: rows * card_h + 56px + 16px;

    Vertical {
        Horizontal {
            TextField {
                height: 56px;
                leading_icon: @image-url("../mdi/magnify.svg");
                label: "Filter";
                placeholder-text: "Search...";
                edited(text) => {
                    filter = text;
                    update_filter(text.to-lowercase());
                }
            }

            SegmentedButton {
                height: 56px;

                items: [
                    { text: "As List", icon: @image-url("../mdi/view-list.svg") },
                    { text: "As Grid", icon: @image-url("../mdi/view-grid.svg") }
                ];
                current_index: as_list ? 0 : 1;
                index_changed(index) => {
                    as_list = index == 0;
                }
            }
        }

        Rectangle {
            for app[index] in apps: OscWiiAppCard {
                x: mod(index, columns) * card_w;
                y: (index / columns).floor() * card_h;
                is_li: as_list;
                width: card_w;
                height: card_h;
                app: app;
            }

            for app[index] in apps: OscWiiAppCardButtons {
                x: mod(index, columns) * card_w;
                y: (index / columns).floor() * card_h + (card_h - 38px);
                width: card_w;
                alignment: as_list ? end : center;
                padding-right: as_list ? 16px : 4px;
                open_oscwii_info => {
                    open_url("https://oscwii.org/library/app/" + app.slug);
                }
                download_oscwii => {
                    download_oscwii(app.zip-url);
                }
                push_oscwii => {
                    push_oscwii(app);
                }
            }
        }
    }
}
