// SPDX-FileCopyrightText: 2025 Manuel Quarneti <mq1@ik.me>
// SPDX-License-Identifier: GPL-3.0-only

import { ScrollView, Vertical, Horizontal, MaterialText, Dialog, TextField } from "@material";
import { HbcAppCard, HbcAppCardButtons, HbcAppInfo } from "hbc_app_card.slint";
import { HbcApp } from "common.slint";

export component HbcAppGrid inherits ScrollView {
    in property <[HbcApp]> apps;
    out property <string> filter: "";

    property <length> card_w: 176px;
    property <length> card_h: 230px;

    property <int> columns: (self.width / card_w).floor();
    property <int> rows: (apps.length / columns).ceil();

    callback open_url(string);
    callback remove_dir(string);
    callback open_app_info(HbcApp);
    callback update_filter(string);

    horizontal-stretch: 1;
    vertical-stretch: 1;
    viewport_height: rows * card_h + 56px + 16px;

    Vertical {
        TextField {
            height: 56px;
            leading_icon: @image-url("../mdi/magnify.svg");
            label: "Filter";
            placeholder-text: "Search...";
            edited(text) => {
                filter = text;
                update_filter(text.to-lowercase());
            }
        }

        Rectangle {
            for app[index] in apps: HbcAppCard {
                x: mod(index, columns) * card_w;
                y: (index / columns).floor() * card_h;
                width: card_w;
                height: card_h;
                app: app;
            }

            for app[index] in apps: HbcAppCardButtons {
                x: mod(index, columns) * card_w;
                y: (index / columns).floor() * card_h + (card_h - 42px);
                width: card_w;
                open_app_info => {
                    open_app_info(app);
                }
                open_app_dir => {
                    open_url(app.path);
                }
                remove_app => {
                    remove_dir(app.path);
                }
            }
        }
    }
}
