// SPDX-FileCopyrightText: 2025 Manuel Quarneti <mq1@ik.me>
// SPDX-License-Identifier: GPL-3.0-only

import { ScrollView, Vertical, Horizontal, MaterialText, Dialog, TextField, SegmentedButton, Icon, FilledIconButton, MaterialPalette } from "@material";
import { LineEdit } from "std-widgets.slint";
import { HbcAppCard, HbcAppCardButtons, HbcAppInfo } from "hbc_app_card.slint";
import { HbcApp, Config } from "common.slint";

export component HbcAppGrid inherits VerticalLayout {
    in property <[HbcApp]> apps;
    out property <string> filter: "";
    in-out property <Config> config;

    property <length> card_w: config.as_list ? self.width - 12px : 177px;
    property <length> card_h: config.as_list ? 42px : 230px;

    property <int> columns: config.as_list ? 1 : (self.width / card_w).floor();
    property <int> rows: config.as_list ? apps.length : (apps.length / columns).ceil();

    callback open_url(string);
    callback remove_dir(string);
    callback open_app_info(HbcApp);
    callback update_filter(string);
    callback update_config();
    callback add_apps();
    callback open_wiiload();

    horizontal-stretch: 1;
    vertical-stretch: 1;

    Rectangle {
        background: MaterialPalette.surface_variant;
        z: 2.0;

        Horizontal {
            VerticalLayout {
                alignment: center;
                Icon {
                    source: @image-url("../mdi/magnify.svg");
                }
            }

            LineEdit {
                height: 37px;
                placeholder-text: "Search...";
                text: filter;
                edited(text) => {
                    filter = text;
                    update_filter(text.to-lowercase());
                }
            }

            SegmentedButton {
                height: 37px;

                items: [
                    { icon: @image-url("../mdi/view-list.svg") },
                    { icon: @image-url("../mdi/view-grid.svg") }
                ];
                current_index: config.as_list ? 0 : 1;
                index_changed(index) => {
                    config.as_list = index == 0;
                    update_config();
                }
            }

            FilledIconButton {
                height: 37px;
                width: 37px;
                tooltip: "Add Apps";
                icon: @image-url("../mdi/plus.svg");
                clicked => {
                    add_apps();
                }
            }

            FilledIconButton {
                height: 37px;
                width: 37px;
                tooltip: "WiiLoad";
                icon: @image-url("../mdi/upload-network.svg");
                clicked => {
                    open_wiiload();
                }
            }
        }
    }

    ScrollView {
        viewport_height: rows * card_h + 4px;

        Rectangle {
            for app[index] in apps: HbcAppCard {
                x: mod(index, columns) * card_w + 4px;
                y: (index / columns).floor() * card_h + 4px;
                is_li: config.as_list;
                width: card_w;
                height: card_h;
                app: app;
            }

            for app[index] in apps: HbcAppCardButtons {
                x: mod(index, columns) * card_w + 4px;
                y: (index / columns).floor() * card_h + (card_h - (config.as-list ? 38px : 42px)) + 4px;
                width: card_w;
                alignment: config.as_list ? end : center;
                padding-right: config.as_list ? 16px : 4px;
                open_app_info => {
                    open_app_info(app);
                }
                open_app_dir => {
                    open_url(app.path);
                }
                remove_app => {
                    remove_dir(app.path);
                }
            }
        }
    }
}
