// SPDX-FileCopyrightText: 2025 Manuel Quarneti <mq1@ik.me>
// SPDX-License-Identifier: GPL-3.0-only

import {
    Vertical,
    Horizontal,
    IconButton,
    MaterialText,
    HorizontalDivider,
    Icon,
    MaterialPalette,
    ScrollView
} from "@material";
import { OscWiiApp } from "common.slint";

component OscWiiAppCard inherits Rectangle {
    in property <OscWiiApp> app;

    callback open_oscwii_info();
    callback download_oscwii();
    callback push_oscwii();

    width: 164px;
    height: 200px;
    background: MaterialPalette.surface;
    border-color: MaterialPalette.outline_variant;
    border-radius: 12px;
    border-width: 1px;

    visible: !app.slug.is-empty;

    Vertical {
        MaterialText {
            horizontal-alignment: center;
            text: app.name;
        }

        HorizontalDivider { }

        Rectangle {
            vertical-stretch: 1;
        }

        Horizontal {
            padding: 4px;

            Icon {
                source: @image-url("../mdi/account.svg");
            }

            MaterialText {
                text: app.author;
            }
        }

        Horizontal {
            padding: 4px;

            Icon {
                source: @image-url("../mdi/tag.svg");
            }

            MaterialText {
                text: app.version;
            }
        }

        Horizontal {
            padding: 4px;

            Icon {
                source: @image-url("../mdi/scale.svg");
            }

            MaterialText {
                text: app.size;
            }
        }

        Rectangle {
            vertical-stretch: 1;
        }

        Horizontal {
            alignment: center;

            IconButton {
                icon: @image-url("../mdi/information.svg");
                tooltip: "App Information";
                inline: true;
                clicked => {
                    open_oscwii_info();
                }
            }

            IconButton {
                icon: @image-url("../mdi/download.svg");
                tooltip: "Download";
                inline: true;
                clicked => {
                    download_oscwii();
                }
            }

            IconButton {
                icon: @image-url("../mdi/upload-network.svg");
                tooltip: "Wiiload";
                inline: true;
                clicked => {
                    push_oscwii();
                }
            }
        }
    }
}

export component OscWiiAppGrid inherits ScrollView {
    in property <[OscWiiApp]> apps;

    private property <int> cols: max(1, self.width / 180px);
    private property <int> rows: ceil(apps.length / cols);

    callback open_oscwii_info(OscWiiApp);
    callback download_oscwii(OscWiiApp);
    callback push_oscwii(OscWiiApp);

    // Disable horizontal scrolling
    viewport_width: self.width - 8px;

    VerticalLayout {
        spacing: 20px; // we leave some space for the tooltips
        padding: 20px;

        for i in rows: HorizontalLayout {
            spacing: 8px;

            for j in cols: OscWiiAppCard {
                app: apps[i * cols + j];
                open_oscwii_info => open_oscwii_info(apps[i * cols + j]);
                download_oscwii => download_oscwii(apps[i * cols + j]);
                push_oscwii => push_oscwii(apps[i * cols + j]);
            }
        }
    }
}
