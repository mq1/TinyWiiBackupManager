// SPDX-FileCopyrightText: 2025 Manuel Quarneti <mq1@ik.me>
// SPDX-License-Identifier: GPL-3.0-only

import { IconButton, Vertical, MaterialText, ElevatedCard, MaterialPalette, Horizontal, CircularProgressIndicator, SnackBar } from "@material";
import { SideBar } from "sidebar.slint";
import { GameGrid } from "game_grid.slint";
import { Game, HbcApp, WiiOutputFormat, ArchiveFormat, TaskType, UpdateInfo, Config, OscWiiApp } from "common.slint";
import { HbcAppGrid } from "hbc_app_grid.slint";
import { SettingsPage } from "settings.slint";
import { Status } from "status.slint";
import { HbcAppInfo } from "hbc_app_card.slint";
import { Wiiload } from "wiiload.slint";
import { OscWiiAppGrid } from "oscwii_app_grid.slint";

export * from "common.slint";

export component MainWindow inherits Window {
    in property <string> app_name: "";
    in-out property <string> dir_name: "";
    in property <string> disk_usage: "";
    in property <bool> is_macos: false;
    in-out property <int> current_index: 0;
    in property <[Game]> games;
    in property <[Game]> filtered_games: [];
    in property <[HbcApp]> hbc_apps;
    in property <[HbcApp]> filtered_hbc_apps: [];
    in property <string> status: "";
    in property <TaskType> task_type: TaskType.Unknown;
    in-out property <int> task_count: 0;
    in property <UpdateInfo> update_info;
    out property <HbcApp> current_app;
    in-out property <Config> config;
    in property <[OscWiiApp]> oscwii_apps: [];
    in property <[OscWiiApp]> filtered_oscwii_apps: [];

    callback choose_mount_point();
    callback open_url(string);
    callback remove_dir(string);
    callback add_games();
    callback add_apps();
    callback open_data_dir();
    callback update_config(Config);
    callback push_zip(string);
    callback update_oscwii_apps();
    callback update_filtered_oscwii_apps(string);
    callback update_filtered_hbc_apps(string);
    callback update_filtered_games(string);

    preferred-width: 800px;
    preferred-height: 600px;
    title: app_name + " • " + games.length + " Games" + (dir_name.is_empty ? "" : " • " + dir_name + " (" + disk_usage + ")");

    HorizontalLayout {
        SideBar {
            current_index <=> current_index;
            is_macos: is_macos;
            game_count: games.length;
            app_count: hbc_apps.length;
            update_info: update_info;
            choose_mount_point => {
                choose_mount_point();
            }
            set-window-title(title) => {
                root.title = app_name + title + (dir_name.is_empty ? "" : " • " + dir_name + " (" + disk_usage + ")");
            }
            add_games => {
                add_games();
            }
            add_apps => {
                add_apps();
            }
            open-url(url) => {
                open_url(url);
            }
            open-wiiload => {
                wiiload.show();
            }
            update_oscwii_apps => {
                if oscwii_apps.length == 0 {
                    update_oscwii_apps();
                    update_filtered_oscwii_apps("");
                }
            }
        }

        VerticalLayout {
            if current_index == 0 && !dir_name.is-empty: GameGrid {
                games: filtered_games;
                open_url(url) => {
                    open_url(url);
                }
                remove_dir(path) => {
                    remove_dir(path);
                }
                update_filter(filter) => {
                    update_filtered_games(filter);
                }
            }

            if current_index == 1 && !dir_name.is-empty: HbcAppGrid {
                apps: filtered_hbc_apps;
                open_app_info(app) => {
                    current_app = app;
                    app_info.show();
                }
                open_url(url) => {
                    open_url(url);
                }
                remove_dir(path) => {
                    remove_dir(path);
                }
                update_filter(filter) => {
                    update_filtered_hbc_apps(filter);
                }
            }

            if current_index == 2: OscWiiAppGrid {
                apps: filtered_oscwii_apps;
                open_url(url) => {
                    open_url(url);
                }
                update_filter(filter) => {
                    update_filtered_oscwii_apps(filter);
                }
            }

            if current_index == 3: SettingsPage {
                config <=> config;
                update_config() => {
                    update_config(config);
                }
                open_data_dir => open_data_dir();
            }

            if dir_name.is-empty && status.is-empty: Vertical {
                alignment: end;
                padding-bottom: 16px;

                MaterialText {
                    text: "⬅  Choose a drive or directory";
                    font-size: 18px;
                }
            }

            if task_count > 0: Status {
                status: status;
                task_type: task_type;
                task_count: task_count;
            }
        }
    }

    app_info := HbcAppInfo {
        width: root.width;
        height: root.height;
        app: current_app;
    }

    wiiload := Wiiload {
        width: root.width;
        height: root.height;
        config <=> config;
        update_config() => {
            update_config(config);
        }
        push_zip => {
            push_zip(config.wii-ip);
        }
    }
}
